## WEEK II - Transport Layer

>Outlines:
>
>- Architecture of the Internet **transport layer**
>  - TCP - definition, aim, functionality
>  - Ports, Sockets
>  - TCP Message: Header + Data => Payload
>- TCP connections
>  - Session-based
>  - Set-up/Tear-down protocol
>  - 

#### 6. Transport Layer

***6.1. Concept*** Ports and Sockets

> IP - Delivers packets <u>between Network Interface Controllers</u> in the *Network Layer*. 
>
> TCP - Delivers packets <u>between processes (e.g. Client and Server)</u> in the *Transport Layer*, identified by a host IP address and a port number. 

- Definition
  - `Transmission Control Protocol (TCP)` - A protocol to transfer the datagram between applications processes. 
  
  - `Ports` - TCP conceptually divides the communications a host can be involved with into **ports**. 
    - Governance
      - Notion of socket is *in* the TCP specification. 
      - Assignment of sockets to services is *outside* the TCP specification. 
      - The Internet Assigned Numbers Authority IANA maintains the list of assigned ports. 
      - Services are assigned on a first-come, first-served process (as per RFC6335). 
  
  - `Sockets` - a combination of an IP address and a port. 
  

***6.2. Concept*** Transport Layer

>Application - Web - **Transport** - Network - Network Interface
>
>↕️ *physical layer delivery* ↕️
>
>Application - Web - **Transport** - Network - Network Interface

- Functionality
  - Deliver packets between two processes
  - Reliable delivery
  - Segment packets
  - Flow control

***6.3. Concept*** TCP Message

>(**Application/Web** Data)
>
>*⬇️ Encapsulation*
>
>[TCP Header + (Application/Web Data)] i.e. Transport Data
>
>*⬇️ Encapsulation*
>
>{IP Header + [IP Data]}
>
>⬇️ Encapsulation
>
>Frame Header+ {Frame Data}

- Definition
  - `TCP Message`  - 
  - `Payload` - The full TCP Message (Header + Data) becomes payload for the IP layer before. 
- Component
  - Header
  - Data contents - Provided by the **Web Layer **or the **Application Layer**. 

***6.4. Concept*** TCP Message Header

- Component

  - A mandatory section consisting of **20 bytes**. 

    - The **source** and **destination ports** (16 bits for each) of the message. 

      > Ports are 16 bits long, so the value is between 0 and 65,535. 

    - **Sequence number** (32 bits): number assigned to the first data byte of this segment (all bytes being numbered for the current session) — *ordering*. 

    - **Acknowledgement Number** (32 bits): 1+number of the byte so far acknowledged - *reliability*. 

    - **Window size** (16 bits): the number of bytes a receiver is ready to receive - *flow control*. 

  - An optional section. 
  
  - Key functionality: Ordering, Reliability, Flow control

---

#### 7. TCP Connections

***7.1. Concept*** Packet-Switching v. Connection-Based Communication

| IP                                                  | TCP                                                          |
| --------------------------------------------------- | ------------------------------------------------------------ |
| Packet <u>switched</u>                              | <u>Session-based</u> (TCP connection)                        |
|                                                     | A session helps with reliability and flow control. Messages can only be sent once a session has been estabilished between sender and receiver. |
| Each datagram/fragement routed <u>independently</u> | A TCP connection is **NOT** a pre-planned route to send messages, so messages are still routed independently. |
| Finds the destination of data                       | Work to send and receive data                                |

***7.2. Concept*** Notion of TCP session

- Phases: 
  1. session set up
  2. data transmission
  3. session tear down
- Note: 
  - Before being able to send data, hosts need to estabilish a connection with a recipient host. 
  - Data can only be sent during an established session. 
  - A TCP connection is one kind of session, and many other protocols utilise sessions. 
  - Within a TCP session, communicating hosts will ensure reliability of delivery and will manage flow control. 

***7.3. Concept*** Client-Server session

- Programmatically & Protocol

  >  ![image-20231004114645221](/Users/kiyoaki/Library/Application Support/typora-user-images/image-20231004114645221.png)
  >
  > ![](/Users/kiyoaki/Library/Application Support/typora-user-images/image-20231004114338419.png)
  >
  > Data[Q,R] is a segment of data with bytes numbered from Q to R-1. 
  >
  > AKC[R] acknowledges receipt of data up to byte R-1 since beginning of session. 

- Set up/Tear down Protocol

  > ![image-20231004115139191](/Users/kiyoaki/Library/Application Support/typora-user-images/image-20231004115139191.png)The TCP protocol defines a finite state machine specifying the lifecycle of a session: 
  >
  > TCP 3-way Handshake (SYN, SYN-ACK, ACK)
  
  - Set-up Protocol
    - Phases: 
      1. Client synchronises (SYN)
      2. Server acknowledge and synchronises (SYN-ACK)
      3. Client acknowledge (ACK)
      4. Connection is setup
  - Tear-down Protocol
    - Phases: 
      1. Client sends finalize (FIN)
      2. Server acknowledges and sends finalize (FIN+ACK)
      3. Client acknowledges (ACK)
      4. Connection is terminated

---

#### 8. TCP functionality and reliability

***8.1. Concept*** Segmentation

- Definition
  - `Segementation` - Application/Web data is segmented into multiple segments, each with their TCP header. 
  - ` Maximum Segment Size (MSS)` - **The largest IP datagram** that the host can handle, minus the IP and TCP header sizes. 
  - `Segment size sharing (negotiation)` - 
    - The MSS value is sent as a TCP header option <u>only in TCP SYN segments</u>. 
    - Each side of a TCP connection reports its MSS value to the other side.
    - The MSS value can vary between the forward and reverse directions of a TCP data flow. 
    - The sending host is required to limit the size of data in a TCP segment to a value <= the MSS reported by the receiving host. 
    
    > e.g. 1500 bytes (MTU) = 1460 bytes (MSS) + 20 bytes (IP header) + 20 bytes (TCP header)

***8.2. Concept*** Reliability 

- Key mechanisms - used by TCP to identify loss of data

  - Acknowledgement messages (ACKs) 
    - Be sent with an **acknowledge number** by the receiver of data, 
    - To tell the sender that data has been received to the specified byte. 
  - Achieved by the sender detecting lost data and retransmitting it. 

- Strategy

  - Duplicate Acknowledgements

    > Assume a *sender* is sending the message to a *receiver*. 
    >
    > *Sender*: sending segment **[1, J]**, **[J,K]**, **[K, L]**...
    >
    > 1. Sends acknowledgment up to byte preceding byte indexed **J**
    > 2. Keeps on sending acknowledgement asking for segment starting with byte indexed **J**
    >
    > *Receiver*: receiving the acknowledge message **AKC[J]** 
    >
    > 3. Resend segment beginning with byte index **J**, i.e., **[J, K]**, ...
    > 4. ...

  - Time-out

    > Assume a *sender* is sending the message to a *receiver*. 
    >
    > *Sender*: 
    >
    > - Set a **start timer** when sending the first segment **[K, L]**. 
    > - Wait until the **timer expires**, if there is no responses, resend unacknowledged segment **[K, LJ**

---

#### 9. TCP Cross-cutting concerns

***9.1. Concept*** Naming

- Ports
  - Wellknown ports: 
    - https: 80
    - smtp: 25
    - daytime: 13
    - https: 443
  - Registered ports: 
    - 1024 - 49151 (assigned by *IANA* for specific services)
  - Dynamic, private or ephemeral ports: 
    - 49152 - 65535 (cannot be assigned by *IANA*)

***9.2. Concept*** Session & States

> IP packet switching
>
> ↕️ **Messages can be sent as long as session is open.** 
>
> Connection-oriented TCP

- Parties maintain state within connection
  - Sender
    - Receiver MSS
    - Next byte to send
    - First byte sent but not acknowledged yet
    - Receiver window size
  - Receiver
    - Received segments
    - Successor of last byte acknowledged
    - Sliding widow status

***9.3. Concept*** Properties

> Generally, TCP not a self-described layer and it is not queryable. 

- Security
  - <u>No security in the original TCP</u> since packet header and contents are visible. 
  - `TLS (Transport Layer Security)` - to secure communications end-to-end
  - Attacks
    - TCP reset attacks
    - TCP connection hijacking
    - TCP SYN floods
- Reliability - TCP is considered 'reliable' 
  - TCP checks if everything that was transmitted was delivered at the receiving end. 
  - TCP provides for the recovery of segments that get lost, are damaged, duplicated or received out of their correct order
  - TCP requires that an acknowledgment message be returned after transmitting data
- Scalability - TCP benefits from IP scalability
  - TCP performance has been extensively studied. Key characteristics are throughput and latency
- Management
  - One issue: <u>Dynamic, private or ephemeral ports</u> can be allocated dynamically by a host. 
- Governance
  - *IANA* standardises the TCP ports. 